import{c as J,r as m,e as He,u as $e,j as e,L as se,y as Q}from"./index-CTUOLzox.js";import{u as Ve}from"./useGetActionsByCustomerId-B4jx5SWF.js";import{u as qe}from"./useGetLead-Bys4sCYc.js";import{u as Se}from"./useGetEmployee-CFsdwArF.js";import{u as ze,a as Ye}from"./useUpdateProject-nTDgg2Uz.js";import{u as Qe,a as Ke}from"./useUpdateUnit-DE-Tamcz.js";import{P as ge}from"./ReactToastify-DJDUlzPv.js";import{S as Je,G as Xe,L as Ze}from"./search-Bu6W58RX.js";import{c as ae,X as te}from"./x-BCj5FFbu.js";import{I as we}from"./info-d8Vgg3__.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const es=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],K=ae("arrow-right",es);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ts=ae("image",ss);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],Ie=ae("message-circle",as),fe=()=>{const{isLoading:C,error:h,data:I,setError:_,_execute:x}=J(),b=m.useCallback(async(S,E={})=>{try{return await x(`projects/${S}`,"GET",null,E)}catch(j){throw _(j),j}},[x,_]);return{isLoading:C,error:h,data:I,execute:b,setError:_}},ve=()=>{const{isLoading:C,error:h,data:I,setError:_,_execute:x}=J(),b=m.useCallback(async(S,E={})=>{try{return await x(`units/${S}`,"GET",null,E)}catch(j){throw _(j),j}},[x,_]);return{isLoading:C,error:h,data:I,execute:b,setError:_}},ns=()=>{const{isLoading:C,error:h,data:I,setError:_,_execute:x}=J(),b=m.useCallback(async(S,E,j,f,c,g,D,L,v,B={})=>{try{return await x("actions","POST",{customer_id:S,sales_id:E,project_id:D,unit_id:L,prev_state:j,prev_substate:c,new_state:f,new_substate:g,notes:v},B)}catch(P){throw _(P),P}},[x,_]);return{isLoading:C,error:h,data:I,execute:b,setError:_}},is=()=>{const{isLoading:C,error:h,data:I,setError:_,_execute:x}=J(),b=m.useCallback(async(S,E,j,f,c,g,D,L={})=>{try{return await x("tasks","POST",{name:S,customer_id:E,sales_id:j,action_id:f,due_date:c,due_date_day_before:g,due_date_hour_before:D,status_day_before:"PENDING",status_hour_before:"PENDING"},L)}catch(v){throw _(v),v}},[x,_]);return{isLoading:C,error:h,data:I,execute:b,setError:_}},os="https://amaar.egypt-tech.com/api/whatsapp/send",cs={CASH:"كاش",INSTALLMENT:"تقسيط"},rs=()=>{const[C,h]=m.useState(!1),[I,_]=m.useState(null),{execute:x}=ve(),{execute:b}=fe(),{execute:S}=Se();return{sendUnit:async f=>{h(!0),_(null);try{const c=f.salesId?await S(f.salesId):null,g=(f.mediaUrls||[]).map(v=>v.startsWith("/uploads")?`https://amaar.egypt-tech.com${v}`:v),D=await fetch(os,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phoneNumber:f.clientPhoneNumber,message:f.customMessage,media:g,sales:c?{id:c.id,name:c.name,number:c.number}:null})}),L=await D.json();if(!D.ok)throw new Error(L.message||"حدث خطأ أثناء إرسال الوحدة");return L}catch(c){const g=c instanceof Error?c.message:"حدث خطأ أثناء إرسال الوحدة";throw _(g),c}finally{h(!1)}},generateMessageTemplate:async f=>{try{const c=await x(f),g=await b(c.project_id),D=c.media?c.media.split(",").map(B=>B.trim().startsWith("/uploads")?`https://amaar.egypt-tech.com${B.trim()}`:B.trim()):[],L=c.payment_method?cs[c.payment_method]||c.payment_method:"غير محدد";return{messageTemplate:`
*معلومات الوحدة العقارية*
        
🏢 *المشروع:* ${g.name}
📍 *الموقع:* ${g.location||"غير محدد"}
🏠 *اسم الوحدة:* ${c.name}
🔢 *رقم الوحدة:* ${c.id}
📏 *المساحة:* ${c.area||"غير محدد"} متر مربع
💰 *السعر:* ${c.price||"غير محدد"} جنيه
💳 *طريقة الدفع:* ${L}
${c.payment_method==="INSTALLMENT"?`
📋 *تفاصيل التقسيط:*
   💵 *المقدم:* ${c.down_payment||"غير محدد"} جنيه
   🔄 *القسط الشهري:* ${c.installment_amount||"غير محدد"} جنيه
   🗓️ *عدد الأقساط:* ${c.number_of_installments||"غير محدد"}`:""}

📝 *ملاحظات:* ${c.unit_notes||"لا توجد ملاحظات"}

للمزيد من المعلومات يرجى التواصل معنا
      `.trim(),mediaUrls:D,unit:c,project:g}}catch(c){throw console.error("Error generating message template:",c),c}},isLoading:C,error:I}},ls="_actionsPage_1egw0_1",ds="_header_1egw0_11",ms="_title_1egw0_25",us="_headerActions_1egw0_37",hs="_searchContainer_1egw0_49",_s="_searchIcon_1egw0_59",Ns="_searchInput_1egw0_75",ps="_viewToggle_1egw0_105",xs="_viewButton_1egw0_119",js="_activeView_1egw0_153",gs="_addButton_1egw0_173",ws="_sendUnitButton_1egw0_201",Is="_emptyState_1egw0_275",Ss="_actionsContainer_1egw0_303",fs="_actionCard_1egw0_315",vs="_actionsListContainer_1egw0_343",bs="_actionListItem_1egw0_355",Es="_actionListHeader_1egw0_381",Ls="_actionListContent_1egw0_399",Ts="_actionListDetails_1egw0_415",Cs="_detailsRow_1egw0_423",Ds="_actionHeader_1egw0_437",Os="_actionDate_1egw0_455",ys="_infoButton_1egw0_465",Bs="_actionContent_1egw0_493",As="_actionStatusFlow_1egw0_501",Us="_stateBox_1egw0_519",Ps="_successState_1egw0_541",Ms="_dangerState_1egw0_551",Gs="_activeState_1egw0_561",Fs="_stateName_1egw0_571",Ws="_substateName_1egw0_583",Rs="_arrowIcon_1egw0_593",ks="_actionDetails_1egw0_603",Hs="_detailItem_1egw0_615",$s="_detailLabel_1egw0_627",Vs="_detailValue_1egw0_637",qs="_notesItem_1egw0_645",zs="_notesText_1egw0_653",Ys="_modalOverlay_1egw0_671",Qs="_modal_1egw0_671",Ks="_modalHeader_1egw0_719",Js="_closeButton_1egw0_753",Xs="_infoContent_1egw0_783",Zs="_infoSection_1egw0_791",et="_infoItem_1egw0_815",st="_infoLabel_1egw0_823",tt="_infoValue_1egw0_837",at="_stateChangeInfo_1egw0_849",nt="_stateInfoBox_1egw0_861",it="_prevStateBox_1egw0_877",ot="_newStateBox_1egw0_887",ct="_arrowIconLarge_1egw0_909",rt="_notesBox_1egw0_921",lt="_modalFooter_1egw0_937",dt="_closeModalButton_1egw0_953",mt="_form_1egw0_985",ut="_formSection_1egw0_993",ht="_stateChangeForm_1egw0_1017",_t="_stateFormGroup_1egw0_1029",Nt="_stateSelect_1egw0_1053",pt="_substateSelect_1egw0_1055",xt="_substateGroup_1egw0_1101",jt="_formGroup_1egw0_1109",gt="_formInput_1egw0_1131",wt="_formTextarea_1egw0_1159",It="_requiredMark_1egw0_1193",St="_cancelButton_1egw0_1203",ft="_submitButton_1egw0_1245",vt="_whatsappRecipient_1egw0_1425",bt="_whatsappIcon_1egw0_1445",Et="_recipientInfo_1egw0_1455",Lt="_recipientLabel_1egw0_1465",Tt="_recipientName_1egw0_1477",Ct="_recipientNumber_1egw0_1489",Dt="_messageHelp_1egw0_1503",Ot="_mediaSection_1egw0_1515",yt="_mediaThumbnails_1egw0_1549",Bt="_mediaThumbnail_1egw0_1549",s={actionsPage:ls,header:ds,title:ms,headerActions:us,searchContainer:hs,searchIcon:_s,searchInput:Ns,viewToggle:ps,viewButton:xs,activeView:js,addButton:gs,sendUnitButton:ws,emptyState:Is,actionsContainer:Ss,actionCard:fs,actionsListContainer:vs,actionListItem:bs,actionListHeader:Es,actionListContent:Ls,actionListDetails:Ts,detailsRow:Cs,actionHeader:Ds,actionDate:Os,infoButton:ys,actionContent:Bs,actionStatusFlow:As,stateBox:Us,successState:Ps,dangerState:Ms,activeState:Gs,stateName:Fs,substateName:Ws,arrowIcon:Rs,actionDetails:ks,detailItem:Hs,detailLabel:$s,detailValue:Vs,notesItem:qs,notesText:zs,modalOverlay:Ys,modal:Qs,modalHeader:Ks,closeButton:Js,infoContent:Xs,infoSection:Zs,infoItem:et,infoLabel:st,infoValue:tt,stateChangeInfo:at,stateInfoBox:nt,prevStateBox:it,newStateBox:ot,arrowIconLarge:ct,notesBox:rt,modalFooter:lt,closeModalButton:dt,form:mt,formSection:ut,stateChangeForm:ht,stateFormGroup:_t,stateSelect:Nt,substateSelect:pt,substateGroup:xt,formGroup:jt,formInput:gt,formTextarea:wt,requiredMark:It,cancelButton:St,submitButton:ft,whatsappRecipient:vt,whatsappIcon:bt,recipientInfo:Et,recipientLabel:Lt,recipientName:Tt,recipientNumber:Ct,messageHelp:Dt,mediaSection:Ot,mediaThumbnails:yt,mediaThumbnail:Bt},$t=()=>{var pe,xe;const{leadId:C}=He(),h=Number.parseInt(C||"0",10),{employee:I}=$e(),_=(I==null?void 0:I.role)==="ADMIN",x=["VISITING","MEETING","FOLLOW_UP"],[b,S]=m.useState([]),[E,j]=m.useState([]),[f,c]=m.useState(!0),[g,D]=m.useState(""),[L,v]=m.useState("cards"),[B,P]=m.useState(!1),[ne,ie]=m.useState(!1),[be,oe]=m.useState(!1),[p,ce]=m.useState(null),[n,Ee]=m.useState(null),[re,le]=m.useState([]),[W,M]=m.useState([]),[O,de]=m.useState(null),[i,y]=m.useState({salesId:0,prevState:"NEW",prevSubstate:"",newState:"NEW",newSubstate:"",projectId:null,unitId:null,notes:""}),[R,k]=m.useState({name:"",dueDate:"",dueTime:"10:00"}),[w,G]=m.useState({projectId:null,unitId:null,messageTemplate:"",mediaUrls:[]}),{execute:Le}=is(),{execute:H,isLoading:Te}=Ve(),{execute:me}=qe(),{execute:$}=Se(),{execute:F}=fe(),{execute:V}=ve(),{execute:X}=ze(),{execute:ue}=Qe(),{execute:he,isLoading:Z}=ns(),{execute:Ce}=Ke(),{execute:De}=Ye(),{sendUnit:Oe,generateMessageTemplate:ye,isLoading:ee}=rs();m.useEffect(()=>{(async()=>{try{if(h){const a=await me(h);Ee(a);const l=await H(h),r=await Promise.all(l.map(async o=>{const u={...o};try{if(o.sales_id){const d=await $(o.sales_id);u.salesName=d.name}if(o.project_id){const d=await F(o.project_id);u.projectName=d.name}if(o.unit_id){const d=await V(o.unit_id);u.unitName=d.name}u.leadName=a.name}catch(d){console.error("Error fetching action details:",d)}return u}));if(S(r),j(r),r.length>0){const o=[...r].sort((u,d)=>new Date(d.created_at).getTime()-new Date(u.created_at).getTime());de(o[0])}const N=await X();le(N),y(o=>({...o,salesId:a.sales_id??0}))}}catch(a){console.error("Error loading lead data:",a)}finally{c(!1)}})()},[h,H,me,$,F,V,X]),m.useEffect(()=>{let t=[...b];if(g){const a=g.toLowerCase();t=t.filter(l=>{var r,N,o,u,d,Y,je;return((r=l.notes)==null?void 0:r.toLowerCase().includes(a))||((N=l.leadName)==null?void 0:N.toLowerCase().includes(a))||((o=l.salesName)==null?void 0:o.toLowerCase().includes(a))||((u=l.projectName)==null?void 0:u.toLowerCase().includes(a))||((d=l.unitName)==null?void 0:d.toLowerCase().includes(a))||((Y=T[l.new_state])==null?void 0:Y.toLowerCase().includes(a))||((je=T[l.prev_state])==null?void 0:je.toLowerCase().includes(a))})}j(t)},[g,b]);const Be=async t=>{if(y(a=>({...a,projectId:t,unitId:null})),t)try{const l=(await ue(t)).filter(r=>r.status!=="SOLD");M(l)}catch(a){console.error("Error fetching units:",a),M([])}else M([])},Ae=t=>{if(y(a=>({...a,newState:t,newSubstate:""})),x.includes(t)){const a={VISITING:"زيارة للعميل",MEETING:"اجتماع مع العميل",FOLLOW_UP:"متابعة مع العميل"},l=new Date;l.setDate(l.getDate()+1);const r=l.toISOString().split("T")[0];k({name:a[t],dueDate:r,dueTime:"10:00"})}},_e=t=>{ce(t),P(!0)},Ne=()=>{O?y(t=>({...t,prevState:O.new_state||"",prevSubstate:O.new_substate||"",salesId:(n==null?void 0:n.sales_id)||0})):n!=null&&n.state&&y(t=>({...t,prevState:n.state||"",prevSubstate:n.substate||"",salesId:n.sales_id||0})),ie(!0)},Ue=()=>{G({projectId:null,unitId:null,messageTemplate:"",mediaUrls:[]}),oe(!0)},A=()=>{P(!1),ie(!1),oe(!1),ce(null)},Pe=(t,a)=>{const l=new Date(`${t}T${a}:00`),r=new Date(l);r.setHours(r.getHours());const N=new Date(l);N.setDate(N.getDate()-1),N.setHours(22,0,0,0);const o=new Date(r);return o.setHours(o.getHours()-1),console.log("Due Date Input:",t,a),console.log("Due Date Object:",l.toISOString()),console.log("Adjusted Due Date (+2h):",r.toISOString()),console.log("Day Before (Previous day 10 PM):",N.toISOString()),console.log("Hour Before (1h before due):",o.toISOString()),{dueDateIso:r.toISOString(),dayBeforeIso:N.toISOString(),hourBeforeIso:o.toISOString()}},Me=async t=>{t.preventDefault();try{if(!h||!i.salesId)throw new Error("Missing required fields");if(i.newState==="CLOSED_WON"&&(!i.projectId||!i.unitId)){alert("يجب اختيار المشروع والوحدة عند إغلاق الصفقة بنجاح");return}await Ge(x.includes(i.newState)?R:void 0)}catch(a){console.error("Error creating action:",a),alert("حدث خطأ أثناء إنشاء الإجراء")}},Ge=async t=>{const a=await he(h,i.salesId,i.prevState,i.newState,i.prevSubstate,i.newSubstate,i.projectId||void 0,i.unitId||void 0,i.notes||void 0);if(t){const{dueDateIso:o,dayBeforeIso:u,hourBeforeIso:d}=Pe(t.dueDate,t.dueTime);await Le(t.name,h,i.salesId,a.id,o,u,d)}if(i.newState==="CLOSED_WON"&&i.unitId&&i.projectId){const o=new Date().toISOString();await Ce(i.unitId,{status:"SOLD",sold_date:o});const u=new FormData,Y=((await F(i.projectId)).sold_count||0)+1;u.append("sold_count",Y.toString()),await De(i.projectId,u)}const l=await H(h),r=await Promise.all(l.map(async o=>{const u={...o};try{if(o.sales_id){const d=await $(o.sales_id);u.salesName=d.name}if(o.project_id){const d=await F(o.project_id);u.projectName=d.name}if(o.unit_id){const d=await V(o.unit_id);u.unitName=d.name}u.leadName=(n==null?void 0:n.name)||""}catch(d){console.error("Error fetching action details:",d)}return u}));if(S(r),j(r),r.length>0){const o=[...r].sort((u,d)=>new Date(d.created_at).getTime()-new Date(u.created_at).getTime());de(o[0])}y({salesId:(n==null?void 0:n.sales_id)||0,prevState:(O==null?void 0:O.new_state)||(n==null?void 0:n.state)||"NEW",prevSubstate:(O==null?void 0:O.new_substate)||(n==null?void 0:n.substate)||"",newState:"NEW",newSubstate:"",projectId:null,unitId:null,notes:""}),A();const N=await X();le(N)},q=t=>{const a=new Date(t);return new Intl.DateTimeFormat("ar-EG",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}).format(a)},T={NEW:" جديد ",CONTACTED:" تم التواصل ",INTERESTED:" مهتم ",VISITING:" زيارة ",MEETING:" اجتماع ",NEGOTIATING:" تفاوض ",QUALIFIED:" مؤهل ",CLOSED_WON:" تم الإغلاق (نجاح) ",CLOSED_LOST:" تم الإغلاق (خسارة) ",FOLLOW_UP:" متابعة "},z={NEW:[],CONTACTED:["CALLBACK_REQUESTED","NO_ANSWER","WRONG_NUMBER"],INTERESTED:["HIGH_INTEREST","MEDIUM_INTEREST","LOW_INTEREST"],VISITING:["SCHEDULED","COMPLETED","CANCELLED"],MEETING:["SCHEDULED","COMPLETED","CANCELLED"],NEGOTIATING:["PRICE_DISCUSSION","PAYMENT_PLAN","FINAL_OFFER"],QUALIFIED:["READY_TO_BUY","NEEDS_FINANCING","CONSIDERING_OPTIONS"],CLOSED_WON:["FULL_PAYMENT","INSTALLMENT_PLAN"],CLOSED_LOST:["PRICE_ISSUE","LOCATION_ISSUE","COMPETITOR","NOT_INTERESTED","OTHER"],FOLLOW_UP:["SCHEDULED","PENDING"]},U={CALLBACK_REQUESTED:"طلب معاودة الاتصال ",NO_ANSWER:"لا يوجد رد ",WRONG_NUMBER:"رقم خاطئ ",HIGH_INTEREST:"اهتمام عالي ",MEDIUM_INTEREST:"اهتمام متوسط ",LOW_INTEREST:"اهتمام منخفض ",SCHEDULED:"مجدول ",COMPLETED:"مكتمل ",CANCELLED:"ملغي ",PRICE_DISCUSSION:"مناقشة السعر ",PAYMENT_PLAN:"خطة الدفع ",FINAL_OFFER:"العرض النهائي ",READY_TO_BUY:"جاهز للشراء ",NEEDS_FINANCING:"يحتاج تمويل ",CONSIDERING_OPTIONS:"يدرس الخيارات ",FULL_PAYMENT:"دفع كامل ",INSTALLMENT_PLAN:"خطة أقساط ",PRICE_ISSUE:"مشكلة في السعر ",LOCATION_ISSUE:"مشكلة في الموقع ",COMPETITOR:"ذهب لمنافس ",NOT_INTERESTED:"غير مهتم ",OTHER:"أخرى ",PENDING:"قيد الانتظار "},Fe=async t=>{if(G(a=>({...a,projectId:t,unitId:null})),t)try{const a=await ue(t);M(a)}catch(a){console.error("Error fetching units:",a),M([])}else M([])},We=async t=>{if(!t){G(a=>({...a,unitId:null,messageTemplate:"",mediaUrls:[]}));return}try{const a=parseInt(t,10);G(N=>({...N,unitId:a}));const{messageTemplate:l,mediaUrls:r}=await ye(a);G(N=>({...N,unitId:a,messageTemplate:l,mediaUrls:r}))}catch(a){console.error("Error generating message template:",a),Q.error("حدث خطأ أثناء تحميل بيانات الوحدة")}},Re=t=>{G(a=>({...a,messageTemplate:t.target.value}))},ke=async t=>{t.preventDefault();try{if(!h||!(n!=null&&n.number)||!w.unitId||!w.messageTemplate){Q.error("يجب ملء جميع الحقول المطلوبة");return}await Oe({clientPhoneNumber:n.number,unitId:w.unitId,salesId:n.sales_id||0,customMessage:w.messageTemplate,mediaUrls:w.mediaUrls}),Q.success("تم إرسال معلومات الوحدة بنجاح"),await he(h,n.sales_id||0,n.state||"NEW",n.state||"NEW",n.substate||"",n.substate||"",w.projectId||void 0,w.unitId||void 0,"تم إرسال بيانات الوحدة عبر واتساب");const a=await H(h),l=await Promise.all(a.map(async r=>{const N={...r};try{if(r.sales_id){const o=await $(r.sales_id);N.salesName=o.name}if(r.project_id){const o=await F(r.project_id);N.projectName=o.name}if(r.unit_id){const o=await V(r.unit_id);N.unitName=o.name}N.leadName=(n==null?void 0:n.name)||""}catch(o){console.error("Error fetching action details:",o)}return N}));S(l),j(l),A()}catch(a){console.error("Error sending unit:",a),Q.error("حدث خطأ أثناء إرسال معلومات الوحدة")}};return e.jsxs("div",{className:s.actionsPage,children:[e.jsxs("div",{className:s.header,children:[e.jsxs("h1",{className:s.title,children:["إجراءات العميل: ",n==null?void 0:n.name]}),e.jsxs("div",{className:s.headerActions,children:[e.jsxs("div",{className:s.searchContainer,children:[e.jsx(Je,{size:18,className:s.searchIcon}),e.jsx("input",{type:"text",placeholder:"بحث...",value:g,onChange:t=>D(t.target.value),className:s.searchInput})]}),e.jsxs("div",{className:s.viewToggle,children:[e.jsx("button",{className:`${s.viewButton} ${L==="cards"?s.activeView:""}`,onClick:()=>v("cards"),"aria-label":"عرض البطاقات",children:e.jsx(Xe,{size:18})}),e.jsx("button",{className:`${s.viewButton} ${L==="list"?s.activeView:""}`,onClick:()=>v("list"),"aria-label":"عرض القائمة",children:e.jsx(Ze,{size:18})})]}),e.jsxs("button",{className:s.sendUnitButton,onClick:Ue,children:[e.jsx(Ie,{size:18}),e.jsx("span",{children:"إرسال وحدة عبر واتساب"})]}),e.jsxs("button",{className:s.addButton,onClick:Ne,children:[e.jsx(ge,{size:18}),e.jsx("span",{children:"إضافة إجراء"})]})]})]}),f?e.jsx(se,{isVisible:!0}):E.length===0?e.jsx("div",{className:s.emptyState,children:g?e.jsx("p",{children:"لا توجد نتائج مطابقة للبحث"}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"لا توجد إجراءات مسجلة لهذا العميل"}),e.jsxs("button",{className:s.addButton,onClick:Ne,children:[e.jsx(ge,{size:18}),e.jsx("span",{children:"إضافة إجراء"})]})]})}):L==="cards"?e.jsx("div",{className:s.actionsContainer,children:E.map(t=>e.jsxs("div",{className:s.actionCard,children:[e.jsxs("div",{className:s.actionHeader,children:[e.jsx("div",{className:s.actionDate,children:q(t.created_at.toString())}),e.jsx("button",{className:s.infoButton,onClick:()=>_e(t),"aria-label":"معلومات",children:e.jsx(we,{size:18})})]}),e.jsxs("div",{className:s.actionContent,children:[e.jsxs("div",{className:s.actionStatusFlow,children:[e.jsxs("div",{className:s.stateBox,children:[e.jsx("span",{className:s.stateName,children:T[t.prev_state||"NEW"]}),t.prev_substate&&e.jsx("span",{className:s.substateName,children:U[t.prev_substate]})]}),e.jsx(K,{className:s.arrowIcon,size:20}),e.jsxs("div",{className:`${s.stateBox} ${t.new_state==="CLOSED_WON"?s.successState:t.new_state==="CLOSED_LOST"?s.dangerState:s.activeState}`,children:[e.jsx("span",{className:s.stateName,children:T[t.new_state||"NEW"]}),t.new_substate&&e.jsx("span",{className:s.substateName,children:U[t.new_substate]})]})]}),e.jsxs("div",{className:s.actionDetails,children:[_&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"المندوب:"}),e.jsx("span",{className:s.detailValue,children:t.salesName||"غير محدد"})]}),t.project_id&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"المشروع:"}),e.jsx("span",{className:s.detailValue,children:t.projectName||"غير محدد"})]}),t.unit_id&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"الوحدة:"}),e.jsx("span",{className:s.detailValue,children:t.unitName||"غير محدد"})]}),t.notes&&e.jsxs("div",{className:s.notesItem,children:[e.jsx("span",{className:s.detailLabel,children:"ملاحظات:"}),e.jsx("span",{className:s.notesText,children:t.notes})]})]})]})]},t.id))}):e.jsx("div",{className:s.actionsListContainer,children:E.map(t=>e.jsxs("div",{className:s.actionListItem,children:[e.jsxs("div",{className:s.actionListHeader,children:[e.jsx("div",{className:s.actionDate,children:q(t.created_at.toString())}),e.jsx("button",{className:s.infoButton,onClick:()=>_e(t),"aria-label":"معلومات",children:e.jsx(we,{size:18})})]}),e.jsxs("div",{className:s.actionListContent,children:[e.jsxs("div",{className:s.actionStatusFlow,children:[e.jsxs("div",{className:s.stateBox,children:[e.jsx("span",{className:s.stateName,children:T[t.prev_state||"NEW"]}),t.prev_substate&&e.jsx("span",{className:s.substateName,children:U[t.prev_substate]})]}),e.jsx(K,{className:s.arrowIcon,size:20}),e.jsxs("div",{className:`${s.stateBox} ${t.new_state==="CLOSED_WON"?s.successState:t.new_state==="CLOSED_LOST"?s.dangerState:s.activeState}`,children:[e.jsx("span",{className:s.stateName,children:T[t.new_state||"NEW"]}),t.new_substate&&e.jsx("span",{className:s.substateName,children:U[t.new_substate]})]})]}),e.jsxs("div",{className:s.actionListDetails,children:[e.jsxs("div",{className:s.detailsRow,children:[_&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"المندوب:"}),e.jsx("span",{className:s.detailValue,children:t.salesName||"غير محدد"})]}),t.project_id&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"المشروع:"}),e.jsx("span",{className:s.detailValue,children:t.projectName||"غير محدد"})]}),t.unit_id&&e.jsxs("div",{className:s.detailItem,children:[e.jsx("span",{className:s.detailLabel,children:"الوحدة:"}),e.jsx("span",{className:s.detailValue,children:t.unitName||"غير محدد"})]})]}),t.notes&&e.jsxs("div",{className:s.notesItem,children:[e.jsx("span",{className:s.detailLabel,children:"ملاحظات:"}),e.jsx("span",{className:s.notesText,children:t.notes})]})]})]})]},t.id))}),B&&p&&e.jsx("div",{className:s.modalOverlay,children:e.jsxs("div",{className:s.modal,children:[e.jsxs("div",{className:s.modalHeader,children:[e.jsx("h2",{children:"تفاصيل الإجراء"}),e.jsx("button",{className:s.closeButton,onClick:A,children:e.jsx(te,{size:20})})]}),e.jsxs("div",{className:s.infoContent,children:[e.jsxs("div",{className:s.infoSection,children:[e.jsx("h3",{children:"معلومات أساسية"}),e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"رقم الإجراء:"}),e.jsx("span",{className:s.infoValue,children:p.id})]}),_&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"العميل:"}),e.jsx("span",{className:s.infoValue,children:p.leadName||"غير محدد"})]}),e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"المندوب:"}),e.jsx("span",{className:s.infoValue,children:p.salesName||"غير محدد"})]})]}),e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"تاريخ الإنشاء:"}),e.jsx("span",{className:s.infoValue,children:q(p.created_at.toString())})]}),e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"آخر تحديث:"}),e.jsx("span",{className:s.infoValue,children:q(p.updated_at.toString())})]})]}),e.jsxs("div",{className:s.infoSection,children:[e.jsx("h3",{children:"تغيير الحالة"}),e.jsxs("div",{className:s.stateChangeInfo,children:[e.jsxs("div",{className:`${s.stateInfoBox} ${s.prevStateBox}`,children:[e.jsx("h4",{children:"الحالة السابقة"}),e.jsx("span",{className:s.stateName,children:T[p.prev_state||"NEW"]}),p.prev_substate&&e.jsx("span",{className:s.substateName,children:U[p.prev_substate]})]}),e.jsx(K,{className:s.arrowIconLarge,size:32}),e.jsxs("div",{className:`${s.stateInfoBox} ${s.newStateBox}`,children:[e.jsx("h4",{children:"الحالة الجديدة"}),e.jsx("span",{className:s.stateName,children:T[p.new_state||"NEW"]}),p.new_substate&&e.jsx("span",{className:s.substateName,children:U[p.new_substate]})]})]})]}),(p.project_id||p.unit_id)&&e.jsxs("div",{className:s.infoSection,children:[e.jsx("h3",{children:"معلومات العقار"}),p.project_id&&e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"المشروع:"}),e.jsx("span",{className:s.infoValue,children:p.projectName||"غير محدد"})]}),p.unit_id&&e.jsxs("div",{className:s.infoItem,children:[e.jsx("span",{className:s.infoLabel,children:"الوحدة:"}),e.jsx("span",{className:s.infoValue,children:p.unitName||"غير محدد"})]})]}),p.notes&&e.jsxs("div",{className:s.infoSection,children:[e.jsx("h3",{children:"ملاحظات"}),e.jsx("div",{className:s.notesBox,children:p.notes})]})]}),e.jsx("div",{className:s.modalFooter,children:e.jsx("button",{className:s.closeModalButton,onClick:A,children:"إغلاق"})})]})}),ne&&e.jsx("div",{className:s.modalOverlay,children:e.jsxs("div",{className:s.modal,children:[e.jsxs("div",{className:s.modalHeader,children:[e.jsx("h2",{children:"إضافة إجراء جديد"}),e.jsx("button",{className:s.closeButton,onClick:A,children:e.jsx(te,{size:20})})]}),e.jsxs("form",{onSubmit:Me,className:s.form,children:[e.jsxs("div",{className:s.formSection,children:[e.jsx("h3",{children:"الحالة"}),e.jsxs("div",{className:s.stateChangeForm,children:[e.jsxs("div",{className:s.stateFormGroup,children:[e.jsx("label",{children:"الحالة السابقة"}),e.jsx("select",{value:i.prevState,className:s.stateSelect,disabled:!0,children:Object.keys(T).map(t=>e.jsx("option",{value:t,children:T[t]},t))}),((pe=z[i.prevState])==null?void 0:pe.length)>0&&e.jsxs("div",{className:s.substateGroup,children:[e.jsx("label",{children:"الحالة الفرعية السابقة"}),e.jsxs("select",{value:i.prevSubstate,className:s.substateSelect,disabled:!0,children:[e.jsx("option",{value:"",children:"بدون حالة فرعية"}),z[i.prevState].map(t=>e.jsx("option",{value:t,children:U[t]},t))]})]})]}),e.jsx(K,{className:s.arrowIconLarge,size:32}),e.jsxs("div",{className:s.stateFormGroup,children:[e.jsx("label",{children:"الحالة الجديدة"}),e.jsx("select",{value:i.newState,onChange:t=>Ae(t.target.value),className:s.stateSelect,required:!0,children:Object.keys(T).map(t=>e.jsx("option",{value:t,children:T[t]},t))}),((xe=z[i.newState])==null?void 0:xe.length)>0&&e.jsxs("div",{className:s.substateGroup,children:[e.jsx("label",{children:"الحالة الفرعية الجديدة"}),e.jsxs("select",{value:i.newSubstate,onChange:t=>y(a=>({...a,newSubstate:t.target.value})),className:s.substateSelect,children:[e.jsx("option",{value:"",children:"بدون حالة فرعية"}),z[i.newState].map(t=>e.jsx("option",{value:t,children:U[t]},t))]})]})]})]})]}),(i.newState==="CLOSED_WON"||i.newState==="NEGOTIATING"||i.newState==="QUALIFIED")&&e.jsxs("div",{className:s.formSection,children:[e.jsx("h3",{children:"معلومات العقار"}),e.jsxs("div",{className:s.formGroup,children:[e.jsxs("label",{htmlFor:"projectId",children:["المشروع ",i.newState==="CLOSED_WON"&&e.jsx("span",{className:s.requiredMark,children:"*"})]}),e.jsxs("select",{id:"projectId",value:i.projectId||"",onChange:t=>Be(t.target.value?Number.parseInt(t.target.value):0),className:s.formInput,required:i.newState==="CLOSED_WON",children:[e.jsx("option",{value:"",children:"اختر المشروع"}),re.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),i.projectId&&e.jsxs("div",{className:s.formGroup,children:[e.jsxs("label",{htmlFor:"unitId",children:["الوحدة ",i.newState==="CLOSED_WON"&&e.jsx("span",{className:s.requiredMark,children:"*"})]}),e.jsxs("select",{id:"unitId",value:i.unitId||"",onChange:t=>y(a=>({...a,unitId:t.target.value?Number.parseInt(t.target.value):null})),className:s.formInput,required:i.newState==="CLOSED_WON",children:[e.jsx("option",{value:"",children:"اختر الوحدة"}),W.length>0?W.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.status,")"]},t.id)):e.jsx("option",{value:"",disabled:!0,children:"لا توجد وحدات متاحة"})]})]})]}),x.includes(i.newState)&&e.jsxs("div",{className:s.formSection,children:[e.jsx("h3",{children:"جدولة مهمة"}),e.jsxs("div",{className:s.formGroup,children:[e.jsx("label",{htmlFor:"taskName",children:"اسم المهمة"}),e.jsx("input",{id:"taskName",type:"text",value:R.name,onChange:t=>k(a=>({...a,name:t.target.value})),className:s.formInput,required:!0})]}),e.jsxs("div",{className:s.formGroup,children:[e.jsx("label",{htmlFor:"taskDate",children:"تاريخ المهمة"}),e.jsx("input",{id:"taskDate",type:"date",value:R.dueDate,onChange:t=>k(a=>({...a,dueDate:t.target.value})),className:s.formInput,required:!0,min:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:s.formGroup,children:[e.jsx("label",{htmlFor:"taskTime",children:"وقت المهمة"}),e.jsx("input",{id:"taskTime",type:"time",value:R.dueTime,onChange:t=>k(a=>({...a,dueTime:t.target.value})),className:s.formInput,required:!0})]})]}),e.jsxs("div",{className:s.formSection,children:[e.jsx("h3",{children:"ملاحظات"}),e.jsxs("div",{className:s.formGroup,children:[e.jsx("label",{htmlFor:"notes",children:"ملاحظات"}),e.jsx("textarea",{id:"notes",value:i.notes,onChange:t=>y(a=>({...a,notes:t.target.value})),className:s.formTextarea,rows:4})]})]}),e.jsxs("div",{className:s.modalFooter,children:[e.jsx("button",{type:"button",className:s.cancelButton,onClick:A,disabled:Z,children:"إلغاء"}),e.jsx("button",{type:"submit",className:s.submitButton,disabled:Z,children:Z||Te?e.jsx(se,{isVisible:!0}):x.includes(i.newState)?"إنشاء المهمة والإجراء":"إضافة إجراء"})]})]})]})}),be&&e.jsx("div",{className:s.modalOverlay,children:e.jsxs("div",{className:s.modal,children:[e.jsxs("div",{className:s.modalHeader,children:[e.jsx("h2",{children:"إرسال معلومات وحدة عبر واتساب"}),e.jsx("button",{className:s.closeButton,onClick:A,children:e.jsx(te,{size:20})})]}),e.jsxs("form",{onSubmit:ke,className:s.form,children:[e.jsxs("div",{className:s.formSection,children:[e.jsxs("div",{className:s.whatsappRecipient,children:[e.jsx(Ie,{size:24,className:s.whatsappIcon}),e.jsxs("div",{className:s.recipientInfo,children:[e.jsx("span",{className:s.recipientLabel,children:"سيتم إرسال الوحدة إلى:"}),e.jsx("span",{className:s.recipientName,children:n==null?void 0:n.name}),e.jsx("span",{className:s.recipientNumber,children:n==null?void 0:n.number})]})]}),e.jsx("h3",{children:"اختيار الوحدة"}),e.jsxs("div",{className:s.formGroup,children:[e.jsxs("label",{htmlFor:"sendProjectId",children:["المشروع ",e.jsx("span",{className:s.requiredMark,children:"*"})]}),e.jsxs("select",{id:"sendProjectId",value:w.projectId||"",onChange:t=>Fe(t.target.value?Number.parseInt(t.target.value):0),className:s.formInput,required:!0,children:[e.jsx("option",{value:"",children:"اختر المشروع"}),re.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),w.projectId&&e.jsxs("div",{className:s.formGroup,children:[e.jsxs("label",{htmlFor:"sendUnitId",children:["الوحدة ",e.jsx("span",{className:s.requiredMark,children:"*"})]}),e.jsxs("select",{id:"sendUnitId",value:w.unitId||"",onChange:t=>We(t.target.value),className:s.formInput,required:!0,children:[e.jsx("option",{value:"",children:"اختر الوحدة"}),W.length>0?W.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.status,")"]},t.id)):e.jsx("option",{value:"",disabled:!0,children:"لا توجد وحدات"})]})]}),w.unitId&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"تعديل الرسالة"}),e.jsxs("div",{className:s.formGroup,children:[e.jsxs("label",{htmlFor:"messageTemplate",children:["نص الرسالة ",e.jsx("span",{className:s.requiredMark,children:"*"})]}),e.jsx("textarea",{id:"messageTemplate",value:w.messageTemplate,onChange:Re,className:s.formTextarea,rows:12,required:!0,dir:"rtl"}),e.jsx("p",{className:s.messageHelp,children:"يمكنك تعديل الرسالة قبل إرسالها. تنسيق النص يدعم استخدام **للتمييز** و *للإمالة*."})]}),w.mediaUrls.length>0&&e.jsxs("div",{className:s.mediaSection,children:[e.jsxs("h3",{children:[e.jsx(ts,{size:18})," الصور المرفقة (",w.mediaUrls.length,")"]}),e.jsx("div",{className:s.mediaThumbnails,children:w.mediaUrls.map((t,a)=>e.jsx("div",{className:s.mediaThumbnail,children:e.jsx("img",{src:t,alt:`صورة ${a+1}`})},a))})]})]})]}),e.jsxs("div",{className:s.modalFooter,children:[e.jsx("button",{type:"button",className:s.cancelButton,onClick:A,disabled:ee,children:"إلغاء"}),e.jsx("button",{type:"submit",className:s.submitButton,disabled:ee||!w.messageTemplate,children:ee?e.jsx(se,{isVisible:!0}):"إرسال عبر واتساب"})]})]})]})})]})};export{$t as default};
